 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/backend/app/crud.py b/backend/app/crud.py
index 134aa0c8d9e4adc6b8f3398be969c17da9db780f..54abee6740b8e21d343a858d359a52915ba43f39 100644
--- a/backend/app/crud.py
+++ b/backend/app/crud.py
@@ -685,64 +685,74 @@ def generate_monthly_bills(db: Session, month: date):
             # Don't overwrite already-paid bills
             if existing_bill.is_paid:
                 continue
 
             existing_bill.total_gyd = total
             existing_bill.fee_gyd = fee
             existing_bill.due_date = due
         else:
             bill = models.Bill(
                 provider_id=prov.id,
                 month=start,
                 total_gyd=total,
                 fee_gyd=fee,
                 due_date=due,
             )
             db.add(bill)
 
     db.commit()
 
 
 
 
 
 def get_provider_fees_due(db: Session, provider_id: int) -> float:
     """
-    Sum of all unpaid fees for this provider, in GYD.
-    Assumes Bill.fee_gyd is only populated after appointments have finished.
+    Amount due for the most recent unpaid bill for this provider, in GYD.
+
+    This mirrors the "Total due" shown on the provider-facing bill by:
+    - Taking the latest unpaid bill (so we don't aggregate across months),
+    - Using the platform fee amount (fee_gyd), and
+    - Applying any available bill credits.
     """
-    total_fees = (
-        db.query(func.coalesce(func.sum(models.Bill.fee_gyd), 0))
+    latest_unpaid_bill = (
+        db.query(models.Bill)
         .filter(
             models.Bill.provider_id == provider_id,
-            models.Bill.is_paid == False,  # unpaid only
+            models.Bill.is_paid == False,
         )
-        .scalar()
+        .order_by(models.Bill.due_date.desc())
+        .first()
     )
-    credits = get_provider_credit_balance(db, provider_id)
 
-    net_due = Decimal(str(total_fees or 0)) - Decimal(str(credits or 0))
+    if not latest_unpaid_bill:
+        return 0.0
+
+    fee_due = Decimal(str(latest_unpaid_bill.fee_gyd or 0))
+    credits = Decimal(str(get_provider_credit_balance(db, provider_id) or 0))
+
+    net_due = fee_due - credits
     if net_due < 0:
         net_due = Decimal("0")
 
     return float(net_due)
 
 
 def _provider_billing_row(db: Session, provider: models.Provider, user: models.User):
     amount_due = get_provider_fees_due(db, provider.id)
     latest_bill = (
         db.query(models.Bill)
         .filter(models.Bill.provider_id == provider.id)
         .order_by(models.Bill.due_date.desc())
         .first()
     )
 
     return {
         "provider_id": provider.id,
         "name": user.full_name or "",
         "account_number": provider.account_number or "",
         "phone": user.phone or "",
         "amount_due_gyd": float(amount_due or 0.0),
         "is_paid": amount_due <= 0,
         "last_due_date": latest_bill.due_date if latest_bill else None,
     }
 
 
EOF
)